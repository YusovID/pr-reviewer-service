# Сервис назначения ревьюеров для Pull Request’ов

[![Go Version](https://img.shields.io/badge/Go-1.25.4-blue.svg)](https://golang.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Linter: golangci-lint](https://img.shields.io/badge/linter-golangci--lint-green.svg)](https://golangci-lint.run/)

Сервис для автоматического назначения ревьюеров на Pull Request'ы, управления командами и пользователями. Реализован в качестве тестового задания для стажировки Backend в Avito (осень 2025).

## Функционал

- **Управление командами**: Создание команд и гибкое управление составом участников (добавление/обновление).
- **Управление пользователями**: Изменение статуса активности пользователя (`isActive`).
- **Жизненный цикл PR**: Создание Pull Request'а с автоматическим назначением до двух ревьюеров из команды автора.
- **Идемпотентное слияние PR**: Возможность пометить PR как `MERGED`. Повторные вызовы не вызывают ошибок.
- **Переназначение ревьюеров**: Замена одного ревьюера на случайного активного участника из его же команды.
- **Получение данных**:
    - Получение списка PR, назначенных конкретному пользователю.
    - Получение информации о команде и ее участниках.
- **Дополнительные возможности**:
    - **Статистика**: Эндпоинт для получения статистики по количеству открытых и смерженных ревью для каждого пользователя.
    - **Массовая деактивация**: API для деактивации всех участников команды с безопасным переназначением их открытых ревью.

## Технологический стек

- **Язык**: Go 1.25.4
- **База данных**: PostgreSQL 17
- **API и роутинг**: `chi` v5, `oapi-codegen` для генерации кода из OpenAPI спецификации.
- **Взаимодействие с БД**: `sqlx`, `squirrel`, `golang-migrate`.
- **Инфраструктура**: Docker, Docker Compose.
- **CI/CD**: Jenkins (Pipeline).
- **Мониторинг**: Prometheus, Grafana.
- **Тестирование**: Unit, Integration (`testcontainers-go`), Load (`k6`).
- **Линтинг**: `golangci-lint`.

## Архитектура и Инфраструктура

Проект построен с использованием принципов **Clean Architecture**. Инфраструктура полностью контейнеризирована:

*   **App**: Основной сервис (Go).
*   **Postgres**: Основная БД.
*   **Migrator**: Init-контейнер для применения миграций.
*   **Prometheus**: Сбор метрик с приложения.
*   **Grafana**: Визуализация метрик.

## Запуск проекта

### Требования
*   Docker & Docker Compose
*   GNU Make (опционально)

### Инструкция по запуску

Команда соберет Docker-образы, поднимет контейнеры с приложением, базой данных и стеком мониторинга:

```bash
make up
# или без make:
docker compose up --build -d
```

### Доступ к сервисам

| Сервис | Адрес | Описание |
| :--- | :--- | :--- |
| **API** | `http://localhost:8083` | Основной API (порт 8083 во избежание конфликтов) |
| **Swagger UI** | `http://localhost:8083/swagger` | Интерактивная документация |
| **Grafana** | `http://localhost:3000` | Дашборды мониторинга |
| **Prometheus** | `http://localhost:9090` | Метрики (доступен внутри Docker сети) |

## Мониторинг (Observability)

В проект внедрена система мониторинга. Приложение экспортирует RED-метрики (Rate, Errors, Duration).

### Grafana
*   **Адрес**: `http://localhost:3000`
*   **Логин/Пароль**: `admin` / `admin` (настраивается в `.env`).
*   **Дашборды**:
    *   **RPS**: Количество запросов в секунду.
    *   **Latency (p95)**: Задержка ответов.
    *   **Go Runtime**: Горутины, потребление памяти (Heap), GC.

## CI/CD (Jenkins)

Для автоматизации процессов используется **Jenkins**. Пайплайн описан в файле `Jenkinsfile` и включает этапы:

1.  **Test & Lint**: Запуск тестов внутри изолированного Docker-контейнера с использованием кэширования модулей.
2.  **Build & Push**: Сборка Docker-образов и пуш в Container Registry.
3.  **Deploy**: Деплой на удаленный VPS по SSH с обновлением контейнеров.

## Конфигурация

Настройки находятся в `config/local.yml` и переменных окружения `.env`.

### Переменные окружения (.env)

```bash
POSTGRES_USER=testuser
POSTGRES_PASSWORD=...
POSTGRES_PORT=5432
POSTGRES_DB=pr-reviewer-service

# Настройки Grafana
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin
```

## Разработка

В проекте используется `Makefile` для автоматизации основных задач.

### Основные команды

-   `make up`: Собрать и запустить всё.
-   `make down`: Остановить контейнеры.
-   `make logs`: Показать логи.
-   `make test`: Запустить unit-тесты.
-   `make test-integration`: Запустить интеграционные тесты.
-   `make test-load`: Запустить нагрузочное тестирование (k6).
-   `make lint`: Запустить линтер.

## Принятые решения

1.  **Observability**: Метрики собираются через middleware (`/metrics`), что позволяет отслеживать состояние продакшена.
2.  **Безопасность CI/CD**: Секреты (SSH ключи, пароли) передаются через Jenkins Credentials, а не хранятся в репозитории.
3.  **Оптимизация Docker**: Используется Multi-stage build (Alpine) для минимизации размера образов.
4.  **Маппинг портов**: Внешний порт изменен на `8083` для избежания конфликтов на хосте, внутренний порт остался стандартным (`8080`).

## Результаты нагрузочного тестирования

Было проведено нагрузочное тестирование с помощью **k6**. Сценарий эмулировал основной поток использования сервиса: создание команды, создание PR и получение списка ревью.

-   **Интенсивность**: 5 итераций в секунду в течение 1 минуты.
-   **Максимальное количество виртуальных пользователей (VUs)**: 50.

**Ключевые результаты:**

| Метрика                      | Результат     | Порог      | Статус  |
| ---------------------------- | ------------- | ---------- | ------- |
| **p(95) http_req_duration**  | `416.07ms`     | `< 10000ms`  | ✅ **PASS** |
| **http_req_failed**          | `0.00%`       | `< 1%`     | ✅ **PASS** |

